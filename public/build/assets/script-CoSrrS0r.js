let l=[];window.addToCart=function(e,t,o,r){const i=document.getElementById(`qty-${e}`),n=Math.max(1,parseInt(i?.value||1)),c=typeof t=="string"?t.replace(/\\'/g,"'"):t,d=l.find(a=>a.id===e);d?d.qty+=n:l.push({id:e,name:c,price:Number(o),qty:n,img:r}),h(),w(),g(),B(e),i&&(i.value=1)};window.addCakeToCart=function(e,t,o){const r=document.getElementById(`selected-id-${e}`);if(!r)return;const i=r.value,n=document.getElementById(`price-${e}`).innerText||"$0.00",c=parseFloat(n.replace("$",""))||0,d=document.getElementById(`qty-${e}`),a=Math.max(1,parseInt(d?.value||1));let s="";const f=document.querySelector(`input[name="size-${e}"]:checked`);if(f){const b=document.querySelector(`label[for="${f.id}"]`);b&&(s=` (${b.innerText})`)}const y=(typeof t=="string"?t.replace(/\\'/g,"'"):t)+s,$=l.find(b=>b.id===i);$?$.qty+=a:l.push({id:i,name:y,price:c,qty:a,img:o}),h(),w(),g(),B(i),d&&(d.value=1)};window.openCart=function(){const e=document.getElementById("cartTableBody");let t="",o=0;if(typeof bootstrap>"u"||typeof bootstrap.Modal>"u"){console.error("Bootstrap 5 JS is required for modals.");return}l.length?(l.forEach((r,i)=>{const n=r.price*r.qty;o+=n,t+=`<tr>
                <td><img src="${r.img}" class="cart-item-img" alt="item"></td>
                <td><span class="fw-semibold text-dark">${u(r.name)}</span></td>
                <td class="col-price">$${Number(r.price).toFixed(2)}</td>
                <td>
                    <div class="input-group input-group-sm" style="width:100px">
                        <button class="btn btn-outline-secondary" type="button" onclick="changeCartQty(${i},-1)">-</button>
                        <input type="text" class="form-control text-center bg-white" value="${r.qty}" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="changeCartQty(${i},1)">+</button>
                    </div>
                </td>
                <td class="fw-bold">$${n.toFixed(2)}</td>
                <td><button class="btn btn-sm btn-outline-danger rounded-circle" style="width:30px;height:30px;padding:0" onclick="removeFromCart(${i})"><i class="fas fa-times"></i></button></td>
            </tr>`}),e.innerHTML=t,document.getElementById("grandTotal").innerText=o.toFixed(2)):(e.innerHTML='<tr><td colspan="6" class="text-center py-4">Your cart is empty</td></tr>',document.getElementById("grandTotal").innerText="0.00"),new bootstrap.Modal(document.getElementById("cartModal")).show()};window.openCheckout=function(){if(typeof bootstrap>"u"||typeof bootstrap.Modal>"u"){console.error("Bootstrap 5 JS is required for modals.");return}if(!l.length){window.showMessage("Cart Status","Your cart is empty!");return}const e=l.reduce((r,i)=>r+i.price*i.qty,0),t=document.getElementById("checkoutTotalAmount");t&&(t.innerText=e.toFixed(2));const o=document.getElementById("cartModal");o&&bootstrap.Modal.getInstance(o)?.hide(),new bootstrap.Modal(document.getElementById("checkoutModal")).show()};window.scrollToSection=function(e){const t=document.getElementById(e);t&&t.scrollIntoView({behavior:"smooth"})};window.submitOrder=function(){if(typeof bootstrap>"u"||typeof bootstrap.Modal>"u"){console.error("Bootstrap 5 JS is required for modals.");return}const e=document.getElementById("checkoutForm");if(!e)return;if(!e.checkValidity()){e.reportValidity();return}const t=document.getElementById("proofFile");if(t&&t.files.length>0&&t.files[0].size/1024/1024>5){window.showMessage("File Error","File is too large (max 5MB)");return}const o=document.getElementById("checkoutModal");o&&bootstrap.Modal.getInstance(o)?.hide();const r=document.getElementById("cartModal");r&&bootstrap.Modal.getInstance(r)?.hide();const i=document.getElementById("loadingModal");new bootstrap.Modal(i).show();const c=new FormData(e),d=l.reduce((a,s)=>a+s.price*s.qty,0);c.append("total",d.toFixed(2)),l.forEach((a,s)=>{c.append(`items[${s}][item_id]`,a.id),c.append(`items[${s}][item_name]`,a.name),c.append(`items[${s}][price]`,Number(a.price).toFixed(2)),c.append(`items[${s}][quantity]`,a.qty),c.append(`items[${s}][total]`,(a.price*a.qty).toFixed(2))}),t&&t.files.length>0&&c.append("proof_image",t.files[0]),fetch("/api/place-order",{method:"POST",body:c}).then(a=>a.json()).then(a=>{const s=bootstrap.Modal.getInstance(i);s&&s.hide(),setTimeout(()=>{if(a.status==="success"){document.getElementById("successReference").innerText=a.reference_no||a.order_id||"";const f=document.getElementById("successModal"),p=bootstrap.Modal.getOrCreateInstance(f);F(),p.show(),f.addEventListener("hidden.bs.modal",()=>location.reload(),{once:!0})}else window.showMessage("Error","Error: "+(a.message||a.error||"Unknown"))},500)}).catch(a=>{const s=bootstrap.Modal.getInstance(i);s&&s.hide(),console.error(a),setTimeout(()=>{window.showMessage("Error","An error occurred. Please try again.")},500)})};window.showMessage=function(e,t){if(typeof bootstrap>"u"||typeof bootstrap.Modal>"u"){console.error("Bootstrap 5 JS is required for modals.");return}const o=document.getElementById("messageModal");if(!o){console.error(`Cannot show message: ${e} - ${t}. Modal element #messageModal not found.`);return}document.getElementById("messageModalTitle").innerText=e,document.getElementById("messageModalBody").innerText=t,new bootstrap.Modal(o).show()};window.updateCakeSelection=function(e,t,o){const r=document.getElementById(`price-${e}`);r&&(r.innerText=`$${Number(o).toFixed(2)}`);const i=document.getElementById(`selected-id-${e}`);i&&(i.value=t),g()};window.changeCartQty=function(e,t){if(!l[e])return;const o=l[e].qty+t;o<=0||(l[e].qty=o,h(),w(),g(),openCart())};window.removeFromCart=function(e){l.splice(e,1),h(),w(),g(),openCart()};async function k(){try{const e=await fetch("/api/data/all");if(!e.ok)throw new Error(`Server returned ${e.status} ${e.statusText}`);const t=await e.json();if(t.error){console.error("DB Error:",t.error);return}C(t.footer||{}),window.__CAROUSEL_DATA=t.carousel||[],T(window.__CAROUSEL_DATA),S(t.marquee||[]),L(t)}catch(e){console.error("Error loading data:",e)}finally{q()}}function q(){const e=document.getElementById("loader-overlay");e&&(e.style.opacity="0",setTimeout(()=>{e.style.visibility="hidden",document.body.style.overflow="",window.scrollTo(0,0)},900))}function m(e,t){if(!t)return;const o=document.getElementById(e);o&&(o.src=t,o.classList.remove("d-none"))}function C(e){const t=e.logo||e.logo1;if(t){m("nav-logo",t),m("footer-logo",t);const o=document.getElementById("loader-logo-img"),r=document.getElementById("loader-spinner");o&&(o.src=t,o.classList.remove("d-none"),r&&r.classList.add("d-none"));const i=document.getElementById("footer-logo-placeholder");i&&i.classList.add("d-none")}if(m("nav-brand-img",e.logo2),e.logo2){const o=document.getElementById("nav-brand-text");o&&o.classList.add("d-none")}m("footer-qr1",e.qr1),m("footer-qr2",e.qr2),m("about-img-1",e.about1),m("about-img-2",e.about2),m("about-img-3",e.about3)}function L(e){e.cookies&&(v(e.cookies.filter(t=>t.category==="Best Seller"),"best-seller-container"),v(e.cookies.filter(t=>t.category==="Featured"),"featured-container"),v(e.cookies.filter(t=>t.category==="Classic"),"classic-container")),e.cakes&&H(e.cakes,"cake-container")}function S(e){const t=document.getElementById("marquee-track-top"),o=document.getElementById("marquee-track-bottom");if(!e||e.length===0)return;const i=[...e,...e,...e].map(n=>`<div class="marquee-item"><img src="${n.img}" alt="${u(n.name)}"></div>`).join("");t&&(t.innerHTML=i),o&&(o.innerHTML=i)}let E=null,M=window.innerWidth<=768;window.addEventListener("resize",()=>{clearTimeout(E),E=setTimeout(()=>{const e=window.innerWidth<=768;e!==M&&(M=e,T(window.__CAROUSEL_DATA||[]))},250)});function T(e){const t=window.innerWidth<=768,o=document.getElementById("desktop-carousel-items"),r=document.getElementById("mobile-carousel-items");if(o&&(o.innerHTML=""),r&&(r.innerHTML=""),!e||e.length===0)return;const i=e.filter(c=>c.type?.toLowerCase()==="desktop"),n=e.filter(c=>c.type?.toLowerCase()==="mobile");!t&&o&&i.length?o.innerHTML=i.map((c,d)=>I(c,d,"desktop-carousel-img")).join(""):t&&r&&n.length&&(r.innerHTML=n.map((c,d)=>I(c,d,"mobile-carousel-img")).join(""))}function I(e,t,o){const r=t===0?"active":"",i=e.img||"";if(!i)return"";const n=i.toLowerCase();return n.endsWith(".mp4")||n.endsWith(".webm")?`
            <div class="carousel-item ${r}">
                <video class="${o} d-block w-100" autoplay loop muted playsinline>
                    <source src="${i}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>
        `:`
        <div class="carousel-item ${r}">
            <img src="${i}" class="${o} d-block w-100" alt="${e.name}">
        </div>
    `}function v(e,t){const o=document.getElementById(t);if(!o)return;if(!e||e.length===0){o.innerHTML='<div class="col-12 text-center text-muted">Coming Soon</div>';return}const r=e.length,i="col-lg-2";let n=-1;r===7||r===8?n=3:(r===9||r===10)&&(n=4);const c=e.map((d,a)=>{let s="";return a===n&&(s='<div class="w-100 d-none d-lg-block"></div>'),`
            <div class="col-4 col-md-4 ${i}">
                <div class="product-card h-100 d-flex flex-column position-relative">
                    <span id="card-badge-${d.id}" class="card-qty-badge d-none">0</span>
                    <img src="${d.img}" alt="${u(d.name)}" loading="lazy">
                    <div class="card-body d-flex flex-column p-2">
                        <h6 class="card-title mb-1" title="${u(d.name)}">${u(d.name)}</h6>
                        <p class="price-tag mb-2">$${Number(d.price).toFixed(2)}</p>
                        <div class="mt-auto">
                            <div class="input-group input-group-sm mb-2">
                                <input type="number" id="qty-${d.id}" value="1" min="1" class="form-control text-center px-1">
                            </div>
                            <button data-item-id="${d.id}" class="btn btn-custom w-100" onclick="addToCart('${d.id}','${x(d.name)}',${Number(d.price)},'${d.img}')">Add</button>
                        </div>
                    </div>
                </div>
            </div>${s}`}).join("");o.innerHTML=c}function H(e,t){const o=document.getElementById(t);if(!o)return;if(!e||e.length===0){o.innerHTML='<div class="col-12 text-center text-muted">Coming Soon</div>';return}const r={};e.forEach(n=>{r[n.name]||(r[n.name]={name:n.name,img:n.img,variants:[]}),r[n.name].variants.push({id:n.id,size:n.size||"",price:Number(n.price)})});let i="";Object.values(r).forEach(n=>{const c=n.variants[0].id,d=n.variants[0],a=n.variants.length>1;let s="";a&&(s=n.variants.map((p,y)=>`
                    <input type="radio" class="btn-check" name="size-${c}" id="opt-${c}-${y}" autocomplete="off" ${y===0?"checked":""} onchange="updateCakeSelection('${c}','${p.id}',${p.price})">
                    <label class="btn btn-outline-pink" for="opt-${c}-${y}">${u(p.size||"Regular")}</label>`).join(""),s=`<div class="mb-1 small fw-bold" style="font-size:0.75rem;color:var(--dark-pink)">Size</div><div class="d-flex flex-wrap justify-content-center mb-2">${s}</div>`);const f=s+`<input type="hidden" id="selected-id-${c}" value="${d.id}">`;i+=`
            <div class="col-4 col-md-4 col-lg-2">
                <div class="product-card h-100 d-flex flex-column position-relative">
                    <span id="badge-wrapper-${c}"></span>
                    <img src="${n.img}" alt="${u(n.name)}" loading="lazy">
                    <div class="card-body d-flex flex-column p-2">
                        <h6 class="card-title mb-1" title="${u(n.name)}">${u(n.name)}</h6>
                        <p class="price-tag mb-2" id="price-${c}">$${d.price.toFixed(2)}</p>
                        <div class="mt-auto">
                            ${f}
                            <div class="input-group input-group-sm mb-2">
                                <input type="number" id="qty-${c}" value="1" min="1" class="form-control text-center px-1">
                            </div>
                            <button data-item-id="${c}" class="btn btn-custom w-100" onclick="addCakeToCart('${c}','${x(n.name)}','${n.img}')">Add</button>
                        </div>
                    </div>
                </div>
            </div>
        `}),o.innerHTML=i,g()}function B(e){const t=document.querySelector(`[data-item-id="${e}"]`);if(!t)return;const o=t.innerHTML;t.innerHTML="âœ“",setTimeout(()=>{t.innerHTML=o},800)}function h(){const e=document.getElementById("cartCount");e&&(e.innerText=l.reduce((t,o)=>t+o.qty,0))}function w(){document.querySelectorAll(".card-qty-badge").forEach(e=>{e.classList.add("d-none"),e.innerText=""}),l.forEach(e=>{const t=document.getElementById(`card-badge-${e.id}`);t&&(t.innerText=e.qty,t.classList.remove("d-none"))})}function g(){document.querySelectorAll('[id^="selected-id-"]').forEach(e=>{const t=e.id.replace("selected-id-",""),o=document.getElementById(`badge-wrapper-${t}`);if(!o)return;const r=e.value,i=l.find(n=>n.id===r);if(i){o.innerHTML=`<span class="card-qty-badge">${i.qty}</span>`;const n=o.querySelector(".card-qty-badge");n&&n.classList.remove("d-none")}else o.innerHTML=""})}function u(e){return e?String(e).replace(/[&<>"'`=\/]/g,function(t){return{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[t]}):""}function x(e){return e?String(e).replace(/'/g,"\\'").replace(/"/g,"&quot;"):""}function F(){document.body.classList.remove("modal-open"),document.querySelectorAll(".modal-backdrop").forEach(e=>e.remove())}document.addEventListener("DOMContentLoaded",k);
